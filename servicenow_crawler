
import pandas as pd
import json
from selenium import webdriver
from selenium.webdriver.edge.service import Service
from selenium.webdriver.edge.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from bs4 import BeautifulSoup
from docx import Document
import os
import re
from webdriver_manager.microsoft import EdgeChromiumDriverManager

# ✅ Read URLs from Excel file
excel_file = "pages.xlsx"  # Ensure this file exists in the same directory
df = pd.read_excel(excel_file, engine='openpyxl')
urls = df['URL'].dropna().tolist()

# ✅ Configure Selenium for Edge (using WebDriver Manager)
edge_options = Options()
# edge_options.add_argument("--headless")  # Uncomment for headless mode
edge_options.add_argument("--disable-gpu")
edge_options.add_argument("--no-sandbox")

service = Service(EdgeChromiumDriverManager().install())
driver = webdriver.Edge(service=service, options=edge_options)

# ✅ Open base URL
base_url = "https://myservice.lloyds.com"
driver.get(base_url)

# ✅ Load cookies from cookies.json
with open("cookies.json", "r") as f:
    cookies = json.load(f)

for cookie in cookies:
    # Selenium expects 'name' and 'value'
    driver.add_cookie({
        'name': cookie['name'],
        'value': cookie['value'],
        'domain': cookie['domain']
    })

# ✅ Refresh page to apply cookies
driver.refresh()

# ✅ Create output directory for Word files
output_dir = "word_exports"
os.makedirs(output_dir, exist_ok=True)

# ✅ Crawl each URL and export content to Word
for url in urls:
    driver.get(url)

    # Wait for page to load fully
    WebDriverWait(driver, 30).until(EC.presence_of_element_located((By.TAG_NAME, "body")))

    # Extract rendered HTML
    soup = BeautifulSoup(driver.page_source, 'html.parser')
    page_text = soup.get_text(separator=' ', strip=True)

    # Get page title for filename
    title = soup.title.string if soup.title else "Untitled"
    safe_title = re.sub(r'[\\\\/:*?"<>|]', '_', title)

    # Create Word document
    doc = Document()
    doc.add_heading(title, level=1)
    doc.add_paragraph(f"Source URL: {url}\n\n")
    doc.add_paragraph(page_text)

    # Save Word file using page title
    word_file_path = os.path.join(output_dir, f"{safe_title}.docx")
    doc.save(word_file_path)
    print(f"✅ Saved content from {url} as '{safe_title}.docx'")

driver.quit()
print(f"✅ All pages processed. Word files saved in '{output_dir}' directory.")
